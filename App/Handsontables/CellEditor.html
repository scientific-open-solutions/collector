<!-- -------------------------------- -->
<!-- App/HandsonTable/CellEditor.html -->
<!-- -------------------------------- -->
<style>
  #ace_cell {
    width: 100%;
    height: 100%;
  }
  #cell_apply_color {
    background-color: #000000;
    color: #ffffff;
  }
  #cell_editor_div {
    width: 100vw!important;
    height: 100vh!important;
    padding: 5%;
    margin-left: 30px;
    margin-top: 100px;
    z-index: 999!important;
    background-color: #ffffff;
    display: none;
  }
  #cell_select_color {
    height: 38px;
    width: 38px;
    border: 1px solid var(--collector_blue)!important;
    border-radius: 5px 0 0 5px;
  }
  #cell_text_size {
    width: 70px;
  }
  .cell_button {
    margin: 2px;
  }
  .ace_content {
    z-index: 9000;
  }
</style>

<div id="cell_editor_div" class="modal show" tabindex="-1" role="dialog" aria-labelledby="cellEditorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document" style="left: 20%;position: absolute;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cellEditorModalLabel">Cell Editor</h5>
      </div>
      <div class="modal-body">
        <table style="width: 100%; height: 100%">
          <tr>
            <td style="width: 66.67%; transform: translateY(-8px);">
              <div class="btn-group" role="group">
                <button class="btn btn-primary cell_button" id="cell_make_bold"><b>B</b></button>
                <button class="btn btn-primary cell_button" id="cell_make_italic"><em>I</em></button>
                <button class="btn btn-primary cell_button" id="cell_make_underline"><u>U</u></button>
              </div>
                <button class="btn btn-primary cell_button" id="cell_make_header">H₂</button>
              </div>
              <div class="btn-group" role="group">
                <input type="color" id="cell_select_color" value="#000000" />
                <button class="btn btn-primary" id="cell_select_color_activate">↓</button>
              </div>
              <button class="btn btn-primary cell_button" id="cell_text_size_btn">Size</button>
              <button class="btn btn-primary cell_button bi bi-arrow-return-left" id="cell_add_brs"></button>
            </td>
            <td style="width: 33.33%;padding-left: 15px;">
              <div style="width: 100%; height: 100%">
                Preview:
                <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
                  <button type="button" id="cell_auto_preview_off" class="cell_preview_on_off btn btn-primary">Off</button>
                  <button type="button" id="cell_auto_preview_on" class="cell_preview_on_off btn btn-outline-primary">Auto</button>
                  <button type="button" id="cell_full_preview_btn" class="cell_preview_on_off btn btn-outline-primary">Full</button>
                </div>
              </div>
            </td>
          </tr>
          <tr>
            <td style="width: 66.67%; height: 100%">
              <div id="ace_cell"></div>
            </td>
            <td style="width: 33.33%; height: 100%; padding-left: 15px;">
              <iframe id="cell_preview_iframe" style="width: 100%; height: 100%"></iframe>
            </td>
          </tr>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cell_undo_btn">Undo All</button>
        <button type="button" class="btn btn-secondary" id="close_cell_editor">Close</button>
        <button type="button" class="btn btn-primary" id="saveChanges">Save changes</button>
      </div>
    </div>
  </div>
</div>

<script>
  var cell_editor_obj = {
    content_before: "",
  };
  var cell_editor = ace.edit("ace_cell"); //create new Ace editor for editing the cell
  cell_editor.getSession().setUseWorker(false);
  cell_editor.setTheme("ace/theme/chrome");
  cell_editor.getSession().setMode("ace/mode/html");
  cell_editor.$blockScrolling = Infinity;

  cell_editor.setOptions({
    //set the standard options used for the trialtype editor
    enableBasicAutocompletion: true,
    enableSnippets: false,
    enableLiveAutocompletion: true,
    maxLines: 50,
    minLines: 30,
    tabSize: 2,
    wrap: true,
  });
  
  cell_editor.commands.addCommand({
    name: "insertBrOnEnter",
    bindKey: { win: "Enter", mac: "Enter" },
      exec: function(cell_editor) {
        cell_editor.navigateDown();    // Move cursor to the next line
        cell_editor.insert("<br>\n");  // Insert <br> and then move to a new line
      }
  });

  cell_editor.$blockScrolling = Infinity;

  cell_editor.on("focus", function () {
    //give the same advice for this as for trialtypes
    helperActivate("PhaseTypes", "", "trialtype_code");
  });

  $("#cell_editor_div").css("height", window.innerHeight - 120);

  $("#cell_auto_preview_off").on("click", function () {
    //turn off the automatic previewing of the simple version of the text (i.e. without all the libraries)
    $("#cell_auto_preview_off").removeClass("btn-outline-primary").addClass("btn-primary");
    $("#cell_auto_preview_on").removeClass("btn-primary").addClass("btn-outline-primary");
    $("#cell_full_preview_btn").removeClass("btn-primary").addClass("btn-outline-primary");
  });
  $("#cell_auto_preview_on").on("click", function () {
    //turn off the automatic previewing of the simple version of the text (i.e. without all the libraries)
    $("#cell_auto_preview_on").removeClass("btn-outline-primary").addClass("btn-primary");
    $("#cell_auto_preview_off").removeClass("btn-primary").addClass("btn-outline-primary");
    $("#cell_full_preview_btn").removeClass("btn-primary").addClass("btn-outline-primary");
  });

  $("#cell_full_preview_btn").on("click", function () {
    //turn on full preview and change button classes
    $("#cell_auto_preview_on").removeClass("btn-primary").addClass("btn-outline-primary");
    $("#cell_auto_preview_off").removeClass("btn-primary").addClass("btn-outline-primary");
    $("#cell_full_preview_btn").removeClass("btn-outline-primary").addClass("btn-primary");
    
    setTimeout(function() {
      $("#cell_auto_preview_off").removeClass("btn-outline-primary").addClass("btn-primary");
      $("#cell_auto_preview_on").removeClass("btn-primary").addClass("btn-outline-primary");
      $("#cell_full_preview_btn").removeClass("btn-primary").addClass("btn-outline-primary");
    }, 500);

    //generate a preview of how the code should actually look in Collector
    doc = document.getElementById("cell_preview_iframe").contentWindow.document;
    doc.open();
    doc.write(libraries + cell_editor.getValue()); // note that the difference here is the libraries
    doc.close();
  });

  $("#cell_undo_btn").on("click", function () {
    cell_editor.setValue(cell_editor_obj.content_before);
  });

  $("#cell_select_color_activate").on("click", function (event) {
    $("#cell_select_color").css({
      display: "block",
      top: "2vh",
      left: "0vw"
    }).focus();
  });

  // Remove blur event to keep color picker visible
  // $("#cell_select_color").on("blur", function() {
  //   $(this).css("display", "none");
  // });

  // Insert <br> tag at the current cursor position when the button is clicked
  $("#cell_add_brs").on("click", function () {
    cell_editor.insert("<br>");
  });

  $("#cell_make_header").on("click", function () {
    cell_wrap_tag(cell_editor, "<h2>", "</h2>", true); // this is partially to reduce confusion between the number 1 and the letter l
  });

  // Insert header tag at the current cursor position when a header option is clicked
  $(".header-option").on("click", function (event) {
    event.preventDefault();
    var header = $(this).data("header");
    cell_editor.insert("<" + header + "></" + header + ">");
  });

  //automatically update the preview with simplified version (if auto-preview is switched on
  cell_editor.getSession().on("change", function () {
    //insert content from ace editor into iframe
    var cell_contents = cell_editor.getValue();

    if (CElectron.fs.home_dir() !== "") {
      cell_contents = cell_contents.replaceAll(
        "\.\./User",
        CElectron.fs.home_dir() + "/User"
      );
    }
    /* hopefully can delete this:
	else if(Collector.is_exe){
    cell_contents = cell_contents.replaceAll("\.\./User","../../../User");
  }
	*/

    if ($("#cell_auto_preview_on").hasClass("btn-primary")) {
      doc = document.getElementById("cell_preview_iframe")
        .contentWindow
        .document;
      doc.open();
      doc.write(cell_contents);
      doc.close();
    }
  });

  cell_editor.completers.push({
    // same suggestions as for trialtype editor, as I think this still applies
    getCompletions: function (cell_editor, session, pos, prefix, callback) {
      callback(null, [
        {
          value: "Phase.add_response()",
          score: 1000,
          meta: "add row to responses",
        },
        { value: "Phase.submit()", score: 1000, meta: "end trial - C" },
        {
          value: "Phase.elapsed()",
          score: 1000,
          meta: "since trial start - C",
        },
        { value: "Phase.set_timer()", score: 1000, meta: "at trial start - C" },
        { value: "Phase.set()", score: 1000, meta: "for another trial -C" },
        { value: "Phase.get()", score: 1000, meta: "from an earlier trial -C" },
      ]);
    },
  });

  $("#close_cell_editor").on("click", function () {
    cell_editor.setValue(cell_editor_obj.content_before);
    // Close and save changes
    this_sheet.setDataAtCell(
      this_selection[0].start.row,
      this_selection[0].start.col,
      cell_editor.getValue()
    );
    $("#cell_editor_div").fadeOut();
  });

  $("#saveChanges").on("click", function () {
    // Close and save changes
    this_sheet.setDataAtCell(
      this_selection[0].start.row,
      this_selection[0].start.col,
      cell_editor.getValue()
    );
    $("#cell_editor_div").fadeOut();
  });

  /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  // check every 10 seconds if the cell editor is visible, and if so, update the cell that is being edited with its contents //
  /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  setInterval(function () {
    if ($("#cell_editor_div").is(":visible")) {
      // i.e. if someone is editing a cell on one of the spreadsheets
      this_sheet.setDataAtCell(
        this_selection[0].start.row, // select the cell by row
        this_selection[0].start.col, // select the cell by column
        cell_editor.getValue()
      ); // what you've been editing
    }
  }, 10000); // every 10 seconds
</script>
<script src="Handsontables/CellEditorKeyboard.js"></script>
