
<!-- ------------------------------ -->
<!-- App/PhaseTypes/PhaseTypes.html -->
<!-- ------------------------------ -->
<!-- <link rel="stylesheet" href="../App/style.css"> -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="libraries/grapes.0.21.12.min.js"></script>
<link rel="stylesheet" href="libraries/grapes.0.21.12.min.css">
<style>
  .user_code {
    background-color: PaleGreen;
  }
  .default_code {
    background-color: LightSkyBlue;
  }
  .form-select {
    display: inline;
    vertical-align: middle;
  }
  #code_preview {
    width: 100%;
    height: 100%;
    margin: 30px;
  }
  #ace_theme {
    position: absolute;
    top: 29px;
    left: 650px;
  }
  #editor_theme_select {
    width: 220px;
    position: absolute;
    transform: translate(4px,1px);
    display: none;
  }
  #save_phasetype_btn{
    display: none;
  }
  #code_preview_fullscreen {
    display: none;
  }
  #gjs {
    width: 78vw!important;
    margin-left: 10px;
  }
  #top_row_btn {
    padding: 4vh 0 10px 10px;
  }
  #code_preview_fullscreen {
    margin-left:5px;
  }
  #code_editor-tab, #graphic_editor-tab, #code-preview-tab {
    display: none;
  }
</style>
<!-- HTML BELOW -->
<div id="PhaseType" class="hide_show_elements">
  <!-- Top Row Elements -->
  <div id="top_row_btn">
    <select id="phasetype_select" class="form-select" previousValue="" style="width:15%;"></select>
    <button id="new_code_button" class="btn btn-primary bi bi-file-earmark-plus">New</button>
    <button id="save_phasetype_btn" class="btn btn-primary">Save</button>
    <button id="rename_phasetypes_button" class="btn btn-primary bi bi-pencil-fill" style="display: none">Rename</button>
    <button id="delete_phasetypes_button" class="btn btn-primary bi bi-trash" style="display: none">Delete</button>
    <button id="view_code_btn" class="btn btn-outline-primary bi bi bi-toggles" style="display: none">Code</button>
    <button id="view_graphic_btn" class="btn btn-outline-primary bi bi-toggles" style="display: none;">Graphic</button>    
    <div class="btn-group" role="group" aria-label="Basic example">
      <button id="assets_folder_btn" class="btn btn-outline-primary bi bi-folder">Assets</button>
      <button id="assets_loc_btn" class="btn btn-outline-primary bi bi-files" title="Copy Asset folder location to clipboard"></button>
    </div>
    <select id="editor_theme_select" class="form-select">
      <option disabled selected hidden>Code Editor Themes</option>
      <option disabled>--- Light ---</option>
      <option>Chrome (Default)</option>
      <option>Clouds</option>
      <option>Crimson Editor</option>
      <option>Dawn</option>
      <option>Dreamweaver</option>
      <option>Eclipse</option>
      <option>Github</option>
      <option>IPlastic</option>
      <option>KatzenMilch</option>
      <option>Kuroir</option>
      <option>Solarized Light</option>
      <option>SQL Server</option>
      <option>TextMate</option>
      <option>Tomorrow</option>
      <option>XCode</option>
      <option disabled>--- Dark ----</option>
      <option>Ambiance</option>
      <option>Chaos</option>
      <option>Clouds Midnight</option>
      <option>Cobalt</option>
      <option>Dracula</option>
      <option>Green on Black</option>
      <option>Gruvbox</option>
      <option>Idle Fingers</option>
      <option>KrTheme</option>
      <option>Merbivore</option>
      <option>Mono Industrial</option>
      <option>Monokai</option>
      <option>Nord Dark</option>
      <option>Pastel on Dark</option>
      <option>Solarized Dark</option>
      <option>Terminal</option>
      <option>Tomorrow Night</option>
      <option>Tomorrow Night Blue</option>
      <option>Tomorrow Night Bright</option>
      <option>Tomorrow Night 80s</option>
      <option>Twilight</option>
      <option>Vibrant Ink</option>
    </select>
  </div>
  <!-- Second Row Elements -->
  <div style="margin-left: 10px;">
    <ul class="nav nav-pills" role="tablist">
      <div class="btn-group" role="group" >
        <button type="button" id="graphic_editor-tab" class="btn btn-outline-info bi bi-brush" data-bs-toggle="pill" data-bs-target="#graphic_editor" role="tab" aria-controls="graphic_editor" aria-selected="false">GUI</button>
        <button type="button" id="code_editor-tab" class="btn btn-outline-info bi bi-file-text" data-bs-toggle="pill" data-bs-target="#code_editor" role="tab" aria-controls="code_editor" aria-selected="false">Editor</button>
        <button type="button" id="code-preview-tab" class="btn btn-outline-info bi bi-eye" data-bs-toggle="pill" data-bs-target="#code-preview" type="button" role="tab" aria-controls="pills-contact" aria-selected="false">Preview</button>
      </div>
      <button id="code_preview_fullscreen" class="btn btn-primary bi bi-arrows-fullscreen">Fullscreen</button>
    </ul>
  </div>
  <!-- Citation / Variable Text -->
  <h6 id="ACE_citation" style="display: none; margin:5px 0 0 10px;">H</h6>
  <!-- Code Editor -->
  <div id="ace_div" style="margin:5px 0 0 10px;">
    <div id="ACE_editor" style="display: none; width: 98%">No PhaseType selected</div>
  </div>
  <!-- Graphics Editor -->
  <div class="tab-content" id="pills-tabContent">
    <div class="tab-pane fade" id="graphic_editor" role="tabpanel" aria-labelledby="graphic_editor-tab">
      <div id="gjs"></div>
      <div id="blocks"></div>
    </div>
    <div class="tab-pane fade" id="code_editor" role="tabpanel" aria-labelledby="code_editor-tab">
    </div>
    <div class="tab-pane fade" id="code-preview" role="tabpanel" aria-labelledby="code-preview-tab">
      <iframe id="code_preview" style="width: 78vw;height: 75vh;border: 1px solid grey; transform: translate(-18px, -20px);"></iframe>
    </div>
  </div>
</div>

<!-- JAVASCRIPT BELOW -->

<script src="iframe_library.js"></script>
<script>
/* 
 * This is just an empty variable that is filled via the PhaseTypeActions if PhaseTypes were created in the graphics editor
 * It's needed to allow us to check whether a file should be able to be opened in the graphics editor or just the code editor 
*/
// var graphics_file; 

// ACE Theme Swap
$("#editor_theme_select").on("change", function () {
  var name = $(this).children(":selected").val()
  if (name == 'Chrome (Default)'){
    var theme_name = 'chrome'
  } else if (name == 'Green on Black'){
    var theme_name = 'gob'
  } else if (name == 'KrTheme'){
    var theme_name = 'kr_theme'
  } else if (name == 'SQL Server'){
    var theme_name = 'sqlserver'
  } else if (name == 'Tomorrow Night 80s'){
    var theme_name = 'tomorrow_night_eighties'
  } else {
    var theme_name = name.toLowerCase().replace(/ /g,"_")
  }
  editor.setTheme("ace/theme/"+ theme_name +"");
  console.log("Theme changed to: " + theme_name);
});

$("#code_select").change(function () {
  if ($('#code_select').attr('previousvalue') == "" ) {
    $('#ace_theme_btn_dark').show();
  } else {
    console.log($('#code_select').val());
  }
});

$("#code_preview_fullscreen").on("click", function () {
    // if already full screen; exit
    // else go fullscreen
    if (
      document.fullscreenElement ||
      document.webkitFullscreenElement ||
      document.mozFullScreenElement ||
      document.msFullscreenElement
    ) {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    } else {
      element = $("#code_preview").get(0);
      if (element.requestFullscreen) {
        element.requestFullscreen();
      } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
      } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
      } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
      }
    }
});

var editor = ace.edit("ACE_editor");
editor.getSession().setUseWorker(false);
editor.setTheme("ace/theme/chrome");
editor.getSession().setMode("ace/mode/html");
editor.$blockScrolling = Infinity;

editor.setOptions({
    enableBasicAutocompletion: true,
    enableSnippets: false,
    enableLiveAutocompletion: true,
    fontSize: 14,
    maxLines: 60,
    minLines: 30,
    tabSize: 2,
    wrap: true,
  });
editor.$blockScrolling = Infinity;

editor.on("focus", function () {
   helperActivate("PhaseType", "", "trialtype_code");
});

editor.completers.push({
    getCompletions: function (editor, session, pos, prefix, callback) {
      callback(null, [
        {
          value: "Phase.add_response()",
          score: 1000,
          meta: "add row to responses",
        },
        {
          value: "Phase.submit()",
          score: 1000,
          meta: "end trial - C",
        },
        {
          value: "Phase.elapsed()",
          score: 1000,
          meta: "since trial start - C",
        },
        {
          value: "Phase.set_timer()",
          score: 1000,
          meta: "at trial start - C",
        },
        {
          value: "Phase.set()",
          score: 1000,
          meta: "for another trial -C",
        },
        {
          value: "Phase.get()",
          score: 1000,
          meta: "from an earlier trial -C",
        },
        {
          value: "Phase.get_proc()",
          score: 1000,
          meta: "load a proc sheet -C",
        },
        {
          value: "Phase.get_stim()",
          score: 1000,
          meta: "load a stim sheet -C",
        },
      ]);
    },
  });

  // This adds the custom 'save' icons
  $('#save_phasetype_btn').prepend('<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 15 15" fill="#fff" style="margin-right: 8px;transform: translateY(-1px);">'+
      '<path fill="#fff" d="m12.313,0H1.758C.789,0,0,.789,0,1.758v11.484c0,.969.789,1.758,1.758,1.758h11.484c.969,0,1.758-.789,1.758-1.758V2.687l-2.687-2.687Zm-7.713,1.172h3.486v2.227h1.172V1.172h1.172v2.812c0,.323-.263.586-.586.586h-4.658c-.323,0-.586-.263-.586-.586V1.172Zm7.002,12.656H3.428v-5.156c0-.323.263-.586.586-.586h7.002c.323,0,.586.263.586.586v5.156Zm2.227-.586c0,.323-.263.586-.586.586h-.469v-5.156c0-.969-.789-1.758-1.758-1.758h-7.002c-.969,0-1.758.789-1.758,1.758v5.156h-.498c-.323,0-.586-.263-.586-.586V1.758c0-.323.263-.586.586-.586h1.67v2.812c0,.969.789,1.758,1.758,1.758h4.658c.969,0,1.758-.789,1.758-1.758V1.172h.226l2.001,2.001v10.07Z"/>'+
      '</svg>');

    </script>
<script src="PhaseTypes/grapes.js"></script>
<script src="PhaseTypes/PhaseTypesFunctions.js"></script>
<script src="PhaseTypes/PhaseTypesActions.js"></script>
