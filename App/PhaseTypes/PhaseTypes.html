<!-- ------------------------------ -->
<!-- App/PhaseTypes/PhaseTypes.html -->
<!-- ------------------------------ -->
<!-- <link rel="stylesheet" href="../App/style.css"> -->
<style>
  .user_code {
    background-color: PaleGreen;
  }
  .default_code {
    background-color: LightSkyBlue;
  }
  #code_preview {
    width: 100%;
    height: 100%;
    margin: 30px;
  }
  #ace_theme {
    position: absolute;
    top: 29px;
    left: 650px;
  }
  #editor_theme_select {
    width: 220px;
    position: absolute;
    transform: translate(4px,1px);
    display: none;
  }
  #save_phasetype_btn{
    display: none;
  }
  #code_preview_fullscreen {
    display: none;
  }
</style>
<br /><br />

<div id="PhaseType" class="hide_show_elements">
  <table>
    <tr>
      <td>
        <ul class="nav nav-pills" role="tablist">
          <div class="btn-group" role="group" >
              <button disabled type="button" id="code_editor-tab" class="btn btn-outline-info bi bi-file-text" data-bs-toggle="pill" data-bs-target="#code_editor" role="tab" aria-controls="code_editor" aria-selected="false">Editor</button>
              <button disabled type="button" id="code-preview-tab" class="btn btn-outline-info bi bi-eye" data-bs-toggle="pill" data-bs-target="#code-preview" type="button" role="tab" aria-controls="pills-contact" aria-selected="false" >Preview</button>
          </div>
        </ul>
      <td>
 
        <!-- <select id="code_project_select" class="form-select" style="margin:2px">
          <option disabled selected>Project (optional)</option>
          <option>None</option>
        </select>
      </td> -->
      <!-- <td>
        <select id="code_procedure_select" class="form-select" style="margin: 2px; display: none">
          <option disabled selected>Procedure sheet (optional)</option>
          <option>None</option>
        </select>
      </td>
      <td>
        <input
          class="form-control"
          type="number"
          placeholder="row"
          style="margin: 2px; width: 100px; display: none"
        />
        <select
          id="code_stimuli_select"
          class="form-select"
          style="margin: 2px; display: none"
        >
          <option disabled selected>Stimuli sheet (optional)</option>
          <option>None</option>
        </select>
      </td> -->
      <td>
        <button id="code_preview_fullscreen" class="btn btn-primary bi bi-arrows-fullscreen">Fullscreen</button>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <div class="tab-content" id="pills-tabContent" style="top: 100px; width: 1000px; height: 800px; position: absolute">
          <div class="tab-pane fade show active" id="code_editor" role="tabpanel" aria-labelledby="pills-spreadsheet-tab">
            <br />
            <div class="row">
              <!--
              <div class="col-md-1">
            		<button class="btn btn-primary" id="community_code_btn">Community</button>
            	</div>
              -->
              <div class="col-md-3">
                <select id="phasetype_select" class="form-select" previousValue=""></select>
              </div>
              <div class="col-md-9">
                <button id="new_code_button" class="btn btn-primary bi bi-file-earmark-plus">New</button>
                <button id="save_phasetype_btn" class="btn btn-primary">Save</button>
                <button id="rename_phasetypes_button" class="btn btn-primary bi bi-pencil-fill" style="display: none">Rename</button>
                <button id="delete_phasetypes_button" class="btn btn-primary bi bi-trash" style="display: none">Delete</button>
                <button id="view_code_btn" class="btn btn-outline-primary bi bi bi-toggles" style="display: none">Code</button>
                <button id="view_graphic_btn" class="btn btn-outline-primary bi bi-toggles" style="display: none;">Graphic</button>    
                <div class="btn-group" role="group" aria-label="Basic example">
                  <button id="assets_folder_btn" class="btn btn-outline-primary bi bi-folder">Assets</button>
                  <button id="assets_loc_btn" class="btn btn-outline-primary bi bi-files" title="Copy Asset folder location to clipboard"></button>
                </div>
                <button id="convert_to_code_btn" class="btn btn-outline-primary bi bi-shuffle" style="display: none">Convert to Code File</button>
                <select id="editor_theme_select" class="form-select">
                  <option disabled selected hidden>Code Editor Themes</option>
                  <option disabled>--- Light ---</option>
                  <option>Chrome (Default)</option>
                  <option>Clouds</option>
                  <option>Crimson Editor</option>
                  <option>Dawn</option>
                  <option>Dreamweaver</option>
                  <option>Eclipse</option>
                  <option>Github</option>
                  <option>IPlastic</option>
                  <option>KatzenMilch</option>
                  <option>Kuroir</option>
                  <option>Solarized Light</option>
                  <option>SQL Server</option>
                  <option>TextMate</option>
                  <option>Tomorrow</option>
                  <option>XCode</option>
                  <option disabled>--- Dark ----</option>
                  <option>Ambiance</option>
                  <option>Chaos</option>
                  <option>Clouds Midnight</option>
                  <option>Cobalt</option>
                  <option>Dracula</option>
                  <option>Green on Black</option>
                  <option>Gruvbox</option>
                  <option>Idle Fingers</option>
                  <option>KrTheme</option>
                  <option>Merbivore</option>
                  <option>Mono Industrial</option>
                  <option>Monokai</option>
                  <option>Nord Dark</option>
                  <option>Pastel on Dark</option>
                  <option>Solarized Dark</option>
                  <option>Terminal</option>
                  <option>Tomorrow Night</option>
                  <option>Tomorrow Night Blue</option>
                  <option>Tomorrow Night Bright</option>
                  <option>Tomorrow Night 80s</option>
                  <option>Twilight</option>
                  <option>Vibrant Ink</option>
                </select>
              </div>
            </div>

            <h6 id="ACE_citation" style="display: none"><em>ACE (https://ace.c9.io/)</em> is used for editing code</h6>
            <div id="ace_div">
              <!--
                This is to allow the ace editor width to change when the helper is shown (or not)
              -->
              <div id="ACE_editor" style="display: none; width: 98%">No PhaseType selected</div>
            </div>
            <div id="graphic_editor" style="display: none"></div>
          </div>
          <div class="tab-pane fade" id="code-preview" role="tabpanel" aria-labelledby="code-preview-tab" style="height: 130%;width: 150%;">
            <iframe id="code_preview"></iframe>
          </div>
        </div>
      </td>
    </tr>
  </table>
</div>

<script src="iframe_library.js"></script>
<script>
/* 
 * This is just an empty variable that is filled via the PhaseTypeActions if PhaseTypes were created in the graphics editor
 * It's needed to allow us to check whether a file should be able to be opened in the graphics editor or just the code editor 
*/
var graphics_file; 

// ACE Theme Swap
$("#editor_theme_select").on("change", function () {
  var name = $(this).children(":selected").val()
  if (name == 'Chrome (Default)'){
    var theme_name = 'chrome'
  } else if (name == 'Green on Black'){
    var theme_name = 'gob'
  } else if (name == 'KrTheme'){
    var theme_name = 'kr_theme'
  } else if (name == 'SQL Server'){
    var theme_name = 'sqlserver'
  } else if (name == 'Tomorrow Night 80s'){
    var theme_name = 'tomorrow_night_eighties'
  } else {
    var theme_name = name.toLowerCase().replace(/ /g,"_")
  }
  editor.setTheme("ace/theme/"+ theme_name +"");
  console.log("Theme changed to: " + theme_name);
});

$("#code_select").change(function () {
  if ($('#code_select').attr('previousvalue') == "" ) {
    $('#ace_theme_btn_dark').show();
  } else {
    console.log($('#code_select').val());
  }
});

$("#code_editor-tab").on("click", function () {
    $("#code_preview").prop("src", "about:blank");
    $(this).addClass("active").removeClass("btn-outline-info").addClass("btn-info");
    $('#code-preview-tab').removeClass("active").removeClass("btn-info").addClass("btn-outline-info");
    // $('#code_preview_fullscreen').prop("disabled", true);
    $('#code_preview_fullscreen').hide();
  });

  //https://stackoverflow.com/a/32100295/4490801
$("#code_preview_fullscreen").on("click", function () {
    // if already full screen; exit
    // else go fullscreen
    if (
      document.fullscreenElement ||
      document.webkitFullscreenElement ||
      document.mozFullScreenElement ||
      document.msFullscreenElement
    ) {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    } else {
      element = $("#code_preview").get(0);
      if (element.requestFullscreen) {
        element.requestFullscreen();
      } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
      } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
      } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
      }
    }
  });

$("#graphic_editor").load(collector_map["Graphic.html"]);

$("#community_code_btn").on("click", function () {
    var win = window.open(
      "https://github.com/scientific-open-solutions/collector/discussions/categories/code",
      "_blank"
    );
  });

$("#code-preview-tab").on("click", function () {
    $(this).addClass("active").removeClass("btn-outline-info").addClass("btn-info");
    $('#code_editor-tab').removeClass("active").removeClass("btn-info").addClass("btn-outline-info");
    $('#code_preview_fullscreen').show();
    
    /* work out if we're in a graphics editor or code editor file and get the appropriate html */

    if(parent.parent.graphicObj) {
      required_code_name = $("#phasetype_select").val();
      var iframe_content = master.phasetypes.user[required_code_name];
    } else {
      var iframe_content = editor.getValue();
    }    

    /* * find and replace items for developmental piloting */
    iframe_variables = eval(iframe_content.split("---development---")[1]);

    if (typeof iframe_variables !== "undefined") {
      iframe_variables.forEach(function (row) {
        var this_key = Object.keys(row);
        if (this_key.length == 0) {
          bootbox.alert("Error: You don't have any keys!");
        } else {
          for (i = 0; i < this_key.length; i++) {
            iframe_content = iframe_content.replaceAll("{{" + this_key[i] + "}}", row[this_key[i]]);
          }
        }
      });
    }

    /* use ../User folder */
    home_dir = CElectron.git.locate_repo({org: $("#select_org").val(),repo: $("#select_repo").val(),});
    iframe_content = iframe_content.replaceAll("../User/", home_dir + "/User/");

    /* change set_timer so it works in the preview */
    iframe_content = iframe_content.replaceAll("Phase.set_timer(function(){", "setTimeout(function(){");

    /* delay any appropriate_message() call so it works in the preview */
    var regex = /appropriate_message\(([^)]*)\)/g;
    iframe_content = iframe_content.replace(regex, function(match) {
      return `setTimeout(function() { ${match} }, 0)`;
    });

    /* change set_timer so it works in the preview */
    iframe_content = iframe_content.replaceAll("Phase.submit()", "appropriate_message('<b>End of Preview</b><br><br>You would now be moved on to the next task/trial if this was a live experiment')");

    doc = document.getElementById("code_preview").contentWindow.document;
    doc.open();
    doc.write(libraries + iframe_content);    
    doc.close();
});

var editor = ace.edit("ACE_editor");
editor.getSession().setUseWorker(false);
editor.setTheme("ace/theme/chrome");
editor.getSession().setMode("ace/mode/html");
editor.$blockScrolling = Infinity;

editor.setOptions({
    enableBasicAutocompletion: true,
    enableSnippets: false,
    enableLiveAutocompletion: true,
    fontSize: 14,
    maxLines: 60,
    minLines: 30,
    tabSize: 2,
    wrap: true,
  });
editor.$blockScrolling = Infinity;

editor.on("focus", function () {
   helperActivate("PhaseType", "", "trialtype_code");
});

editor.completers.push({
    getCompletions: function (editor, session, pos, prefix, callback) {
      callback(null, [
        {
          value: "Phase.add_response()",
          score: 1000,
          meta: "add row to responses",
        },
        {
          value: "Phase.submit()",
          score: 1000,
          meta: "end trial - C",
        },
        {
          value: "Phase.elapsed()",
          score: 1000,
          meta: "since trial start - C",
        },
        {
          value: "Phase.set_timer()",
          score: 1000,
          meta: "at trial start - C",
        },
        {
          value: "Phase.set()",
          score: 1000,
          meta: "for another trial -C",
        },
        {
          value: "Phase.get()",
          score: 1000,
          meta: "from an earlier trial -C",
        },
        {
          value: "Phase.get_proc()",
          score: 1000,
          meta: "load a proc sheet -C",
        },
        {
          value: "Phase.get_stim()",
          score: 1000,
          meta: "load a stim sheet -C",
        },
      ]);
    },
  });

  // This adds the custom 'save' icons
$('#save_phasetype_btn').prepend('<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 15 15" fill="#fff" style="margin-right: 8px;transform: translateY(-1px);">'+
    '<path fill="#fff" d="m12.313,0H1.758C.789,0,0,.789,0,1.758v11.484c0,.969.789,1.758,1.758,1.758h11.484c.969,0,1.758-.789,1.758-1.758V2.687l-2.687-2.687Zm-7.713,1.172h3.486v2.227h1.172V1.172h1.172v2.812c0,.323-.263.586-.586.586h-4.658c-.323,0-.586-.263-.586-.586V1.172Zm7.002,12.656H3.428v-5.156c0-.323.263-.586.586-.586h7.002c.323,0,.586.263.586.586v5.156Zm2.227-.586c0,.323-.263.586-.586.586h-.469v-5.156c0-.969-.789-1.758-1.758-1.758h-7.002c-.969,0-1.758.789-1.758,1.758v5.156h-.498c-.323,0-.586-.263-.586-.586V1.758c0-.323.263-.586.586-.586h1.67v2.812c0,.969.789,1.758,1.758,1.758h4.658c.969,0,1.758-.789,1.758-1.758V1.172h.226l2.001,2.001v10.07Z"/>'+
    '</svg>');
</script>
<script type="text/javascript" src="PhaseTypes/PhaseTypesFunctions.js"></script>
<script type="text/javascript" src="PhaseTypes/PhaseTypesActions.js"></script>