<!--
/*  Collector (Garcia, Kornell, Kerr, Blake & Haffey)
    A program for running experiments on the web
    Copyright 2012-2020 Mikey Garcia & Nate Kornell


    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License version 3 as published by
    the Free Software Foundation.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>

		Kitten/Cat release (2019-2022) author: Dr. Anthony Haffey (team@someopen.solutions)
*/

-->

<style>
#redcap_interface{
  position: absolute;
  top: 60px;
  width: 100%;
}
</style>

<div id="redcap_interface">


  <div class="custom-file">
    <input
      type="file"
      class="custom-file-input"
      id="upload_data_csv"
      aria-describedby="upload_data_csv_addon"
      multiple
    />
    <label class="custom-file-label" for="upload_data_csv"
      >Upload Project</label
    >
  </div>
  <button id="download_redcap_dictionary">download</button>

</div>



<script>

var redcap_array = [];

$("#download_redcap_dictionary").on("click", function(){

  Collector.save_data(
    "dictionary.csv",
    Papa.unparse(redcap_array, {
      quotes: false, //or array of booleans
      quoteChar: '"',
      escapeChar: '"',
      delimiter: ",",
      header: true,
      newline: "\r\n",
      skipEmptyLines: true, //or 'greedy',
      columns: null, //or array of strings
    })
  );


});

$("#upload_data_csv").on("change", function () {
  if (this.files && this.files[0]) {

    for(var i = 0; i < this.files.length; i++){
      var myFile = this.files[i];
      var reader = new FileReader();
      var this_filename = this.files[i].name;
      reader.addEventListener("load", function (e) {

        var this_csv = Collector.PapaParsed(e.target.result);

        var this_location = this_csv[this_csv.length-1].location;

        var this_org = this_csv[this_csv.length-1].organization;
        var this_repo = this_csv[this_csv.length-1].repository;

        var these_headers = Object.keys(this_csv[0]);


        /*
         * prevent adding an identical row
         */


        if(redcap_array.filter(function(row){
          return row["Variable / Field Name"] == "record_id"
        }).length == 0){
          redcap_array.push({

            "Variable / Field Name": "record_id",
            "Form Name": this_org + "_" + this_repo,
            "Section Header": "",
            "Field Type": "text",
            "Field Label": "Record ID",
            "Choices, Calculations, OR Slider Labels": "",
            "Field Note": "",
            "Text Validation Type OR Show Slider Number": "",
            "Text Validation Min": "",
            "Text Validation Max": "",
            "Identifier?": "",
            "Branching Logic (Show field only if...)": "",
            "Required Field?": "",
            "Custom Alignment": "",
            "Question Number (surveys only)": "",
            "Matrix Group Name": ""
          });
        }



        these_headers.forEach(function(this_header){
          if(redcap_array.filter(function(row){
            return row["Variable / Field Name"] == this_location + "_" + this_header &
            row["Form Name"] == this_location &
            row["Field Type"] == "text"
          }).length == 0 & this_header !== ""){
            redcap_array.push({
              "Variable / Field Name": this_header,
              "Form Name": this_org + "_" + this_repo,
              "Section Header": "",
              "Field Type": "text",
              "Field Label": this_header,
              "Choices, Calculations, OR Slider Labels": "",
              "Field Note": "",
              "Text Validation Type OR Show Slider Number": "",
              "Text Validation Min": "",
              "Text Validation Max": "",
              "Identifier?": "",
              "Branching Logic (Show field only if...)": "",
              "Required Field?": "",
              "Custom Alignment": "",
              "Question Number (surveys only)": "",
              "Matrix Group Name": ""
            });

          }
        });

        //upload_exp_contents(e.target.result, this_filename);
      });
      reader.readAsBinaryString(myFile);
    }
  }
});
</script>
